import{getStore}from"../../redux/store";import{cloneDeep}from"lodash";import translate,{activeBundle,availableLocales}from"../../i18n/index";import{getProxyUrl}from"../../api/apiRequest";import{ESDEV_POPUP_PIXIE_EDITOR}from"../../const";import{showError}from"../../controllers/notifications/NotificationsController";let pixieEditor,localeConfig,editorLocale;export function init(e="en",i){if(editorLocale=availableLocales.indexOf(e)>-1?e:"en",localeConfig={active:editorLocale,custom:{[`${e}`]:getLanguageBundle()}},pixieEditor)return void i();const t=$(`.${ESDEV_POPUP_PIXIE_EDITOR}`);t.find("pixie-editor").remove(),t.prepend('<pixie-editor style="position: fixed"></pixie-editor>');let o={crossOrigin:getStore().getState().config.useCredentialsForAssets?"use-credentials":"anonymous",urls:{assets:`${window.Stripo.bp}assets/imageeditor/`},ui:{openImageDialog:!1,mode:"overlay",toolbar:{hideCloseButton:!1}},onLoad:()=>{i()}};const{config:r}=getStore().getState(),n=r&&r.imageEditor&&r.imageEditor.stickers&&r.imageEditor.stickers.emotIcons;if(n){const e=cloneDeep(Pixie.prototype.getDefaultConfig("tools.stickers")),i=e.items.find((e=>"emoticons"===e.name));n.exclude&&n.exclude.length&&(i.list=i.list.filter((e=>!n.exclude.includes(e)))),n.include&&n.include.length&&(i.list=i.list.filter((e=>n.include.includes(e)))),o.tools={stickers:e}}if(!getStore().getState().config.imageEditor.stickersEnable){const e=Pixie.prototype.getDefaultConfig("ui.nav"),i=e.items.filter((e=>"stickers"!==e.name));o.ui.nav=Object.assign(e,{items:i})}pixieEditor=new Pixie(o)}export function openEditor(e,i,t,o,r,n){r&&r(),pixieEditor.setConfig("languages",localeConfig),pixieEditor.setConfig("onOpen",(()=>{n&&n()})),pixieEditor.setConfig("onSave",function(i,o){t(e,i,o),pixieEditor.close()}.bind(this)),pixieEditor.setConfig("onClose",function(){o&&o()}.bind(this)),pixieEditor.setConfig("onImageLoadError",function(){showError(translate("image.edit.load.error"))}.bind(this));const s=i&&(i.endsWith(".jpg")||i.endsWith(".jpeg"))?"jpeg":"png";pixieEditor.setConfig("tools.export.defaultFormat",s);const l=$(`.${ESDEV_POPUP_PIXIE_EDITOR}`);l.css("display","none"),pixieEditor.resetAndOpenEditor("image",createImageSrcProxy(i)).then((()=>{l.css("display","block")}),(()=>{}))}export function destroy(){pixieEditor&&(pixieEditor.destroyEditor(),pixieEditor=null)}function getLanguageBundle(){const e={};for(let i of Object.keys(activeBundle))i.startsWith("pixie.")&&(e[i.replace("pixie.","")]=activeBundle[i]);return e}export function createImageSrcProxy(e){const i=getStore().getState().config;return`${i.pluginMode?getProxyUrl():i.imagesProxy}?url=${e}`}